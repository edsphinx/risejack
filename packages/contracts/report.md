# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Storage Array Edited with Memory](#h-1-storage-array-edited-with-memory)
  - [H-2: ETH transferred without address checks](#h-2-eth-transferred-without-address-checks)
  - [H-3: Weak Randomness](#h-3-weak-randomness)
  - [H-4: Reentrancy: State change after external call](#h-4-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unspecific Solidity Pragma](#l-2-unspecific-solidity-pragma)
  - [L-3: Public Function Not Used Internally](#l-3-public-function-not-used-internally)
  - [L-4: Literal Instead of Constant](#l-4-literal-instead-of-constant)
  - [L-5: PUSH0 Opcode](#l-5-push0-opcode)
  - [L-6: Modifier Invoked Only Once](#l-6-modifier-invoked-only-once)
  - [L-7: Costly operations inside loop](#l-7-costly-operations-inside-loop)
  - [L-8: State Change Without Event](#l-8-state-change-without-event)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 4 |
| Total nSLOC | 636 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| RiseJack.sol | 524 |
| interfaces/IVRFConsumer.sol | 7 |
| interfaces/IVRFCoordinator.sol | 7 |
| mocks/MockVRFCoordinator.sol | 98 |
| **Total** | **636** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 4 |
| Low | 8 |


# High Issues

## H-1: Storage Array Edited with Memory

Storage reference is passed to a function with a memory parameter. This will not update the storage variable as expected. Consider using storage parameters instead.

<details><summary>9 Found Instances</summary>


- Found in RiseJack.sol [Line: 398](src/RiseJack.sol#L398)

	```solidity
	        (uint8 playerValue,) = calculateHandValue(game.playerCards);
	```

- Found in RiseJack.sol [Line: 399](src/RiseJack.sol#L399)

	```solidity
	        (uint8 dealerValue,) = calculateHandValue(game.dealerCards);
	```

- Found in RiseJack.sol [Line: 439](src/RiseJack.sol#L439)

	```solidity
	        (uint8 playerValue,) = calculateHandValue(game.playerCards);
	```

- Found in RiseJack.sol [Line: 485](src/RiseJack.sol#L485)

	```solidity
	        (uint8 dealerValue, bool isSoft) = calculateHandValue(game.dealerCards);
	```

- Found in RiseJack.sol [Line: 530](src/RiseJack.sol#L530)

	```solidity
	        (uint8 dealerValue, bool isSoft) = calculateHandValue(game.dealerCards);
	```

- Found in RiseJack.sol [Line: 562](src/RiseJack.sol#L562)

	```solidity
	        (uint8 playerValue,) = calculateHandValue(game.playerCards);
	```

- Found in RiseJack.sol [Line: 563](src/RiseJack.sol#L563)

	```solidity
	        (uint8 dealerValue,) = calculateHandValue(game.dealerCards);
	```

- Found in RiseJack.sol [Line: 725](src/RiseJack.sol#L725)

	```solidity
	        return calculateHandValue(games[player].playerCards);
	```

- Found in RiseJack.sol [Line: 741](src/RiseJack.sol#L741)

	```solidity
	            (value,) = calculateHandValue(game.dealerCards);
	```

</details>



## H-2: ETH transferred without address checks

Consider introducing checks for `msg.sender` to ensure the recipient of the money is as intended.

<details><summary>4 Found Instances</summary>


- Found in RiseJack.sol [Line: 289](src/RiseJack.sol#L289)

	```solidity
	    function stand() external gameInState(msg.sender, GameState.PlayerTurn) {
	```

- Found in RiseJack.sol [Line: 322](src/RiseJack.sol#L322)

	```solidity
	    function surrender() external gameInState(msg.sender, GameState.PlayerTurn) {
	```

- Found in RiseJack.sol [Line: 751](src/RiseJack.sol#L751)

	```solidity
	    function withdraw() external {
	```

- Found in RiseJack.sol [Line: 767](src/RiseJack.sol#L767)

	```solidity
	    function cancelTimedOutGame(address player) external {
	```

</details>



## H-3: Weak Randomness

The use of keccak256 hash functions on predictable values like block.timestamp, block.number, or similar data, including modulo operations on these values, should be avoided for generating randomness, as they are easily predictable and manipulable. The `PREVRANDAO` opcode also should not be used as a source of randomness. Instead, utilize Chainlink VRF for cryptographically secure and provably random values to ensure protocol integrity.

<details><summary>7 Found Instances</summary>


- Found in RiseJack.sol [Line: 253](src/RiseJack.sol#L253)

	```solidity
	        uint256 seed = uint256(keccak256(abi.encode(msg.sender, block.timestamp, block.prevrandao, nonce)));
	```

- Found in RiseJack.sol [Line: 273](src/RiseJack.sol#L273)

	```solidity
	        uint256 seed = uint256(keccak256(abi.encode(msg.sender, block.timestamp, games[msg.sender].playerCards.length, nonce)));
	```

- Found in RiseJack.sol [Line: 306](src/RiseJack.sol#L306)

	```solidity
	        uint256 seed = uint256(keccak256(abi.encode(msg.sender, block.timestamp, "double", nonce)));
	```

- Found in RiseJack.sol [Line: 511](src/RiseJack.sol#L511)

	```solidity
	            uint256 seed = uint256(keccak256(abi.encode(player, block.timestamp, "dealer", nonce)));
	```

- Found in RiseJack.sol [Line: 537](src/RiseJack.sol#L537)

	```solidity
	            uint256 seed = uint256(keccak256(abi.encode(player, block.timestamp, game.dealerCards.length, nonce)));
	```

- Found in mocks/MockVRFCoordinator.sol [Line: 120](src/mocks/MockVRFCoordinator.sol#L120)

	```solidity
	            randomNumbers[i] = uint256(keccak256(abi.encode(seed, i, block.timestamp)));
	```

</details>



## H-4: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>3 Found Instances</summary>


- Found in RiseJack.sol [Line: 254](src/RiseJack.sol#L254)

	State is changed at: `vrfRequests[requestId] = VRFRequest({
            player: msg.sender,
            requestType: RequestType.InitialDeal,
            fulfilled: false
        })`
	```solidity
	        uint256 requestId = coordinator.requestRandomNumbers(4, seed);
	```

- Found in RiseJack.sol [Line: 274](src/RiseJack.sol#L274)

	State is changed at: `vrfRequests[requestId] = VRFRequest({
            player: msg.sender,
            requestType: RequestType.PlayerHit,
            fulfilled: false
        })`
	```solidity
	        uint256 requestId = coordinator.requestRandomNumbers(1, seed);
	```

- Found in RiseJack.sol [Line: 307](src/RiseJack.sol#L307)

	State is changed at: `vrfRequests[requestId] = VRFRequest({
            player: msg.sender,
            requestType: RequestType.PlayerHit, // Will trigger dealer play after
            fulfilled: false
        })`
	```solidity
	        uint256 requestId = coordinator.requestRandomNumbers(1, seed);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>7 Found Instances</summary>


- Found in RiseJack.sol [Line: 793](src/RiseJack.sol#L793)

	```solidity
	    function setBetLimits(uint256 _minBet, uint256 _maxBet) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 800](src/RiseJack.sol#L800)

	```solidity
	    function withdrawHouseFunds(uint256 amount) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 807](src/RiseJack.sol#L807)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 817](src/RiseJack.sol#L817)

	```solidity
	    function pause() external onlyOwner {
	```

- Found in RiseJack.sol [Line: 826](src/RiseJack.sol#L826)

	```solidity
	    function unpause() external onlyOwner {
	```

- Found in RiseJack.sol [Line: 838](src/RiseJack.sol#L838)

	```solidity
	    function setDailyProfitLimit(uint256 _limit) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 846](src/RiseJack.sol#L846)

	```solidity
	    function setMinReserve(uint256 _reserve) external onlyOwner {
	```

</details>



## L-2: Unspecific Solidity Pragma

Consider using a specific version of Solidity in your contracts instead of a wide version. For example, instead of `pragma solidity ^0.8.0;`, use `pragma solidity 0.8.0;`

<details><summary>4 Found Instances</summary>


- Found in RiseJack.sol [Line: 2](src/RiseJack.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

- Found in interfaces/IVRFConsumer.sol [Line: 2](src/interfaces/IVRFConsumer.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

- Found in interfaces/IVRFCoordinator.sol [Line: 2](src/interfaces/IVRFCoordinator.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

- Found in mocks/MockVRFCoordinator.sol [Line: 2](src/mocks/MockVRFCoordinator.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

</details>



## L-3: Public Function Not Used Internally

If a function is marked public but is not used internally, consider marking it as `external`.

<details><summary>1 Found Instances</summary>


- Found in RiseJack.sol [Line: 708](src/RiseJack.sol#L708)

	```solidity
	    function getCardInfo(uint8 card) public pure returns (uint8 rank, uint8 suit) {
	```

</details>



## L-4: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>26 Found Instances</summary>


- Found in RiseJack.sol [Line: 238](src/RiseJack.sol#L238)

	```solidity
	        totalExposure += (msg.value * BLACKJACK_PAYOUT) / 100 + msg.value;
	```

- Found in RiseJack.sol [Line: 254](src/RiseJack.sol#L254)

	```solidity
	        uint256 requestId = coordinator.requestRandomNumbers(4, seed);
	```

- Found in RiseJack.sol [Line: 377](src/RiseJack.sol#L377)

	```solidity
	        require(randomNumbers.length >= 4, "Need 4 random numbers");
	```

- Found in RiseJack.sol [Line: 403](src/RiseJack.sol#L403)

	```solidity
	        if (playerValue == 21 && dealerValue == 21) {
	```

- Found in RiseJack.sol [Line: 410](src/RiseJack.sol#L410)

	```solidity
	        } else if (playerValue == 21) {
	```

- Found in RiseJack.sol [Line: 413](src/RiseJack.sol#L413)

	```solidity
	            uint256 payout = (game.bet * BLACKJACK_PAYOUT) / 100 + game.bet;
	```

- Found in RiseJack.sol [Line: 417](src/RiseJack.sol#L417)

	```solidity
	        } else if (dealerValue == 21) {
	```

- Found in RiseJack.sol [Line: 442](src/RiseJack.sol#L442)

	```solidity
	        if (playerValue > 21) {
	```

- Found in RiseJack.sol [Line: 447](src/RiseJack.sol#L447)

	```solidity
	        } else if (playerValue == 21) {
	```

- Found in RiseJack.sol [Line: 502](src/RiseJack.sol#L502)

	```solidity
	            if (tempValue > 21 && tempSoft) {
	```

- Found in RiseJack.sol [Line: 503](src/RiseJack.sol#L503)

	```solidity
	                tempValue -= 10;
	```

- Found in RiseJack.sol [Line: 534](src/RiseJack.sol#L534)

	```solidity
	        if (_shouldDealerHit(dealerValue, isSoft) && game.dealerCards.length < 10) {
	```

- Found in RiseJack.sol [Line: 554](src/RiseJack.sol#L554)

	```solidity
	        if (value < 17) return true;
	```

- Found in RiseJack.sol [Line: 555](src/RiseJack.sol#L555)

	```solidity
	        if (value == 17 && isSoft) return true;
	```

- Found in RiseJack.sol [Line: 568](src/RiseJack.sol#L568)

	```solidity
	        if (dealerValue > 21) {
	```

- Found in RiseJack.sol [Line: 587](src/RiseJack.sol#L587)

	```solidity
	        uint256 maxPayout = (bet * BLACKJACK_PAYOUT) / 100 + bet;
	```

- Found in RiseJack.sol [Line: 678](src/RiseJack.sol#L678)

	```solidity
	            uint8 cardRank = cards[i] % 13; // 0=A, 1=2, ..., 12=K
	```

- Found in RiseJack.sol [Line: 684](src/RiseJack.sol#L684)

	```solidity
	            } else if (cardRank >= 10) {
	```

- Found in RiseJack.sol [Line: 686](src/RiseJack.sol#L686)

	```solidity
	                total += 10;
	```

- Found in RiseJack.sol [Line: 694](src/RiseJack.sol#L694)

	```solidity
	        while (total > 21 && aces > 0) {
	```

- Found in RiseJack.sol [Line: 695](src/RiseJack.sol#L695)

	```solidity
	            total -= 10;
	```

- Found in RiseJack.sol [Line: 699](src/RiseJack.sol#L699)

	```solidity
	        return (total, aces > 0 && total <= 21);
	```

- Found in RiseJack.sol [Line: 709](src/RiseJack.sol#L709)

	```solidity
	        return (card % 13, card / 13);
	```

- Found in RiseJack.sol [Line: 775](src/RiseJack.sol#L775)

	```solidity
	        uint256 maxPayout = (refund * BLACKJACK_PAYOUT) / 100 + refund;
	```

</details>



## L-5: PUSH0 Opcode

Solc compiler version 0.8.20 switches the default target EVM version to Shanghai, which means that the generated bytecode will include PUSH0 opcodes. Be sure to select the appropriate EVM version in case you intend to deploy on a chain other than mainnet like L2 chains that may not support PUSH0, otherwise deployment of your contracts will fail.

<details><summary>4 Found Instances</summary>


- Found in RiseJack.sol [Line: 2](src/RiseJack.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

- Found in interfaces/IVRFConsumer.sol [Line: 2](src/interfaces/IVRFConsumer.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

- Found in interfaces/IVRFCoordinator.sol [Line: 2](src/interfaces/IVRFCoordinator.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

- Found in mocks/MockVRFCoordinator.sol [Line: 2](src/mocks/MockVRFCoordinator.sol#L2)

	```solidity
	pragma solidity ^0.8.28;
	```

</details>



## L-6: Modifier Invoked Only Once

Consider removing the modifier or inlining the logic into the calling function.

<details><summary>5 Found Instances</summary>


- Found in RiseJack.sol [Line: 162](src/RiseJack.sol#L162)

	```solidity
	    modifier onlyVRFCoordinator() {
	```

- Found in RiseJack.sol [Line: 172](src/RiseJack.sol#L172)

	```solidity
	    modifier validBet() {
	```

- Found in RiseJack.sol [Line: 182](src/RiseJack.sol#L182)

	```solidity
	    modifier whenNotPaused() {
	```

- Found in RiseJack.sol [Line: 187](src/RiseJack.sol#L187)

	```solidity
	    modifier checkReserve() {
	```

- Found in RiseJack.sol [Line: 197](src/RiseJack.sol#L197)

	```solidity
	    modifier checkDailyLimit(address player) {
	```

</details>



## L-7: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>1 Found Instances</summary>


- Found in RiseJack.sol [Line: 465](src/RiseJack.sol#L465)

	```solidity
	        for (uint256 i = 0; i < randomNumbers.length; i++) {
	```

</details>



## L-8: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>4 Found Instances</summary>


- Found in RiseJack.sol [Line: 793](src/RiseJack.sol#L793)

	```solidity
	    function setBetLimits(uint256 _minBet, uint256 _maxBet) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 807](src/RiseJack.sol#L807)

	```solidity
	    function transferOwnership(address newOwner) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 838](src/RiseJack.sol#L838)

	```solidity
	    function setDailyProfitLimit(uint256 _limit) external onlyOwner {
	```

- Found in RiseJack.sol [Line: 846](src/RiseJack.sol#L846)

	```solidity
	    function setMinReserve(uint256 _reserve) external onlyOwner {
	```

</details>



